<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>PipelineLens v4 ‚Äî PRF + Dual RAT (Modern OoO)</title>
<style>
:root[data-theme="dark"]{--bg:#0b0f14;--fg:#e8eef6;--muted:#9fb0c3;--acc:#67d2ff;--ok:#6ee7a8;--warn:#ffd166;--err:#ff6b6b;--card:#121822;--chip:#1a2230;--line:#223049;--ink:#0d131b;--border:#202a39}
:root[data-theme="light"]{--bg:#f6f8fb;--fg:#0b0f14;--muted:#44566c;--acc:#0f79d0;--ok:#0a8f5d;--warn:#b77900;--err:#c0392b;--card:#ffffff;--chip:#f1f5fb;--line:#dfe7f3;--ink:#f4f7fc;--border:#cfd9e6}
*{box-sizing:border-box}body{background:var(--bg);color:var(--fg);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0}
header{padding:12px 18px;border-bottom:1px solid var(--border);display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
h1{font-size:18px;margin:0}.small{font-size:12px;color:var(--muted)}.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,'Courier New',monospace}
.pill{display:inline-block;background:var(--chip);border:1px solid var(--line);padding:2px 8px;border-radius:999px}
button{background:var(--chip);border:1px solid var(--line);color:var(--fg);border-radius:10px;padding:8px 10px;cursor:pointer}
button.primary{background:var(--acc);color:#000}button.warn{background:var(--warn);color:#000}
.container{padding:16px 18px;display:grid;grid-template-columns:1.25fr .75fr;gap:16px}
@media(max-width:1200px){.container{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
.card h3{margin:0 0 8px 0;font-size:14px;color:var(--muted)}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:768px){.grid2{grid-template-columns:1fr}}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.kv{display:flex;flex-wrap:wrap;gap:6px}.kv div{background:var(--chip);border:1px solid var(--line);border-radius:8px;padding:6px 8px;font-size:12px}
table{width:100%;border-collapse:collapse;font-size:12px}th,td{border-bottom:1px solid var(--line);padding:6px 8px;text-align:left;vertical-align:top}
tr.highlight td{background:rgba(103,210,255,0.12)}
textarea{width:100%;background:var(--ink);color:var(--fg);border:1px solid var(--line);border-radius:8px;padding:8px;font-family:inherit}
.badge{padding:2px 6px;border-radius:6px;border:1px solid var(--line);display:inline-block;font-size:11px}
.b-exec{background:#0f213b;color:#67d2ff}.b-wb{background:#0f3b25;color:#6ee7a8}.b-commit{background:#29113b;color:#a47de8}.b-stall{background:#3b1010;color:#ff6b6b}
.toast{position:fixed;right:24px;bottom:96px;background:rgba(0,0,0,.75);color:#fff;padding:8px 12px;border-radius:8px;font-size:12px;opacity:0;animation:fade 2.6s forwards;z-index:50}
@keyframes fade{0%{opacity:0;transform:translateY(10px)}10%{opacity:1;transform:translateY(0)}90%{opacity:1}100%{opacity:0}}
#renamePanel{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;max-width:780px;width:92%;z-index:60;display:none}
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);backdrop-filter:blur(2px);display:none;z-index:55}
.progress{height:8px;background:var(--chip);border:1px solid var(--line);border-radius:6px;overflow:hidden}
.progress>div{height:100%;background:var(--acc)}
</style>
</head>
<body>
<header>
  <div class="row">
    <h1>PipelineLens v4 ‚Äî PRF + Dual RAT</h1>
    <span class="small">ADD=1 cyc, MUL=6 cyc, Issue=2, Commit=2 (RS only tags, values PRF‚Äôde)</span>
  </div>
  <div class="row">
    <div>Cycle: <span id="cycle" class="pill mono">0</span></div>
    <button id="btnPrev">‚óÄ Prev</button>
    <button id="btnStep" class="primary">Step ‚ñ∂</button>
    <button id="btnAuto">Auto ‚ñ∑</button>
    <select id="speed" class="pill"><option value="700">√ó1</option><option value="350">√ó2</option><option value="175">√ó4</option></select>
    <button id="btnReset" class="warn">Reset ‚Ü∫</button>
    <button id="btnTheme">üåô / ‚òÄÔ∏è</button>
    <button id="btnOpenRename">Rename Panel</button>
  </div>
</header>

<div class="container">
  <div class="card">
    <h3>Program & Controls</h3>
    <div class="grid2">
      <div>
        <div class="small">Instruction list (OP src1, src2 -> dst)</div>
        <textarea id="prog" rows="8" class="mono">MUL R1, R2 -> R3
ADD R3, R4 -> R5
ADD R2, R6 -> R7
ADD R8, R9 -> R10
MUL R7, R10 -> R11
ADD R5, R11 -> R5</textarea>
        <div class="row" style="margin-top:8px"><button id="btnLoad">Load Program</button></div>
      </div>
      <div>
        <div class="stats" id="statsBar">
          <div class="row">
            <div class="pill">IPC: <span id="ipc" class="mono">0.00</span></div>
            <div class="pill">ROB: <span id="activeRob" class="mono">0</span></div>
            <div class="pill">ALU use: <span id="aluUse" class="mono">0%</span></div>
            <div class="pill">MDU use: <span id="mduUse" class="mono">0%</span></div>
            <div class="pill">Committed: <span id="commCount" class="mono">0</span></div>
          </div>
          <div style="margin-top:8px">
            <div class="small">PRF usage</div>
            <div class="progress"><div id="prfUsage" style="width:0%"></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>Reservation Stations (RS) ‚Äî only tags</h3>
    <table>
      <thead><tr><th>#</th><th>Instr</th><th>S1 Tag(ready)</th><th>S2 Tag(ready)</th><th>Dst Tag</th><th>FU</th><th>State</th></tr></thead>
      <tbody id="rs"></tbody>
    </table>
  </div>

  <div class="card">
    <h3>ROB (Dest PRF + old PRF for free-at-commit)</h3>
    <table>
      <thead><tr><th>#</th><th>Instr</th><th>Dst PR</th><th>Old PR</th><th>WB?</th><th>Commit?</th></tr></thead>
      <tbody id="rob"></tbody>
    </table>
  </div>

  <div class="card">
    <h3>PRF (Physical Register File)</h3>
    <div id="prf" class="kv mono"></div>
  </div>

  <div class="card">
    <h3>Maps (RAT)</h3>
    <div class="grid2">
      <div><div class="small">Frontend Map (speculative)</div><div id="fmap" class="kv mono"></div></div>
      <div><div class="small">Architectural Map (committed)</div><div id="amap" class="kv mono"></div></div>
    </div>
  </div>

  <div class="card">
    <h3>Cycle Log</h3>
    <div id="log" class="mono small"></div>
  </div>
</div>

<div id="overlay"></div>
<div id="renamePanel" class="card">
  <div class="row" style="justify-content:space-between"><h3>Rename Panel</h3><button id="btnCloseRename">Close</button></div>
  <div class="small">Bu panel sadece rename akƒ±≈üƒ±nƒ± adƒ±m adƒ±m g√∂sterir. Olu≈üan sonu√ßlar ana sim√ºlasyona uygulanƒ±r.</div>
  <div class="row" style="margin:8px 0">
    <button id="btnRenameStep">Run Rename Step</button>
    <button id="btnRenameAll">Rename All</button>
    <button id="btnRenameReset">Reset Rename</button>
    <button id="btnRenameApply">Apply to Main</button>
  </div>
  <div id="renameLog" class="mono small"></div>
</div>

<script>
var LAT = { ADD:1, MUL:6 };
var FU  = { ADD:"ALU", MUL:"MDU" };
var UNITS = { ALU:1, MDU:1 };
var ISSUE_WIDTH=2, COMMIT_WIDTH=2;
var ARCH_N=64, PRF_MAX=256;

function parseProgram(text){
  var lines = text.split(/[\r\n]+/).map(function(s){return s.trim();}).filter(function(s){return !!s;});
  var out = [];
  for(var i=0;i<lines.length;i++){
    var line = lines[i];
    var m = line.match(/^([A-Z]+)\s+([Rr]\d+)\s*,\s*([Rr]\d+)\s*->\s*([Rr]\d+)$/);
    if(!m) throw new Error("Line " + (i+1) + ": bad syntax \"" + line + "\"");
    var op = m[1].toUpperCase();
    if(!(op in FU)) throw new Error("Line " + (i+1) + ": unsupported OP \"" + op + "\"");
    out.push({idx:i+1, op:op, src:["R"+(+m[2].slice(1)),"R"+(+m[3].slice(1))], dst:"R"+(+m[4].slice(1))});
  }
  return out;
}

function buildInitialState(program){
  var fmap={}, amap={}, free=[], prf={}, prfReady={}, prfAllocCount=0;
  for(var i=1;i<=ARCH_N;i++){ var p="p"+i; fmap["R"+i]=p; amap["R"+i]=p; prf[p]=(i<=11?i:0); prfReady[p]=(i<=11?true:true); prfAllocCount++; }
  for(var j=ARCH_N+1;j<=PRF_MAX;j++) free.push("p"+j);
  return { cycle:0, prog:program, fmap:fmap, amap:amap, free:free, prf:prf, prfReady:prfReady, prfAllocCount:prfAllocCount,
    ROB:[], RS:[], inflight:{ALU:0,MDU:0}, execEnds:{}, wbQ:{}, commitPtr:0, log:[], hist:[], metrics:{ticks:0,comm:0,alu:0,mdu:0} };
}

function renameOne(state, inst){
  var s1 = state.fmap[inst.src[0]], s2 = state.fmap[inst.src[1]];
  var old = state.fmap[inst.dst];
  var dstP = state.free.shift();
  state.fmap[inst.dst] = dstP; state.prfReady[dstP]=false; state.prf[dstP]=0; state.prfAllocCount++;
  var rsEntry = {idx:inst.idx, op:inst.op, s1:s1, s2:s2, d:dstP, fu:FU[inst.op], issued:false, start:null, end:null, done:false};
  state.RS.push(rsEntry);
  state.ROB.push({idx:inst.idx, op:inst.op, dst:dstP, old:old, wb:false, commit:false});
  return {line:"i"+inst.idx+": " + inst.op + " " + inst.src[0] + "," + inst.src[1] + " -> " + inst.dst + " | " + s1 + "," + s2 + " -> " + dstP + " (old "+old+")"};
}
function renameAll(state){ var logs=[]; for(var i=0;i<state.prog.length;i++){ logs.push(renameOne(state, state.prog[i]).line); } return logs; }

function canIssue(entry, state){ return state.prfReady[entry.s1] && state.prfReady[entry.s2] && !entry.issued && state.inflight[entry.fu] < UNITS[entry.fu]; }
function startExec(entry, state, t){
  entry.issued=true; entry.start=t; entry.end=t + LAT[entry.op]; state.inflight[entry.fu]++;
  var v1 = state.prf[entry.s1], v2 = state.prf[entry.s2];
  entry.result = (entry.op==="ADD") ? (v1+v2) : (v1*v2);
  (state.execEnds[entry.end] = state.execEnds[entry.end] || []).push(entry);
  state.log.push("Issue@t"+t+": i"+entry.idx+" -> "+entry.fu);
}
function writebackAllDue(state, t){
  var ended = state.execEnds[t] || [];
  for(var i=0;i<ended.length;i++){
    var e = ended[i];
    state.inflight[e.fu]--;
    state.prf[e.d] = e.result; state.prfReady[e.d]=true; e.done=true;
    var rob = state.ROB.find(function(r){return r.idx===e.idx;}); rob.wb=true;
    state.log.push("WB@t"+t+": i"+e.idx+" -> "+e.d+" = "+e.result);
  }
  delete state.execEnds[t];
}
function tryCommit(state, t){
  var committed=0;
  while(committed<COMMIT_WIDTH && state.commitPtr<state.ROB.length){
    var head = state.ROB[state.commitPtr];
    if(head.wb){
      head.commit=true; state.amap[state.prog[head.idx-1].dst]=head.dst;
      state.free.push(head.old); state.prfAllocCount--;
      state.commitPtr++; committed++; state.metrics.comm++;
      state.log.push("Commit@t"+t+": i"+head.idx+" (free "+head.old+")");
    }else break;
  }
}

function step(state){
  var t = state.cycle+1; state.log=[];
  writebackAllDue(state, t);
  var issued=0;
  for(var i=0;i<state.RS.length;i++){ var e = state.RS[i]; if(canIssue(e,state)){ startExec(e,state,t); issued++; if(issued>=ISSUE_WIDTH) break; } }
  tryCommit(state, t);
  state.cycle=t; state.metrics.ticks++; if(state.inflight.ALU>0) state.metrics.alu++; if(state.inflight.MDU>0) state.metrics.mdu++;
}

var S=null, HIST=[], autoTimer=null;
function setTheme(theme){ document.documentElement.dataset.theme=theme; try{localStorage.setItem("pl_theme",theme);}catch(e){} }
function toggleTheme(){ var cur=document.documentElement.dataset.theme||"dark"; setTheme(cur==="dark"?"light":"dark"); }
function showToast(lines){ if(!lines||!lines.length) return; var d=document.createElement("div"); d.className="toast"; d.innerHTML=lines.join("<br>"); document.body.appendChild(d); setTimeout(function(){if(d.parentNode)d.parentNode.removeChild(d);},2600); }

function renderPRF(){
  var host=document.getElementById("prf"); host.innerHTML="";
  var keys=Object.keys(S.prf).sort(function(a,b){return Number(a.slice(1))-Number(b.slice(1));});
  for(var i=0;i<Math.min(96,keys.length);i++){ var k=keys[i]; var v=S.prf[k]; var r=S.prfReady[k];
    var d=document.createElement("div"); d.textContent=k+":"+(r?"V":"P")+"="+v; d.style.color=r?"#6ee7a8":"#67d2ff"; host.appendChild(d);
  }
  var usage = Math.min(100, Math.round(100*S.prfAllocCount/PRF_MAX)); document.getElementById("prfUsage").style.width=usage+"%";
}
function renderMaps(){
  function draw(id,map){ var host=document.getElementById(id); host.innerHTML=""; var regs=[]; for(var i=1;i<=16;i++) regs.push("R"+i);
    for(var j=0;j<regs.length;j++){ var r=regs[j]; var d=document.createElement("div"); d.textContent=r+"‚Üí"+(map[r]||"‚Äî"); host.appendChild(d); }
  }
  draw("fmap",S.fmap); draw("amap",S.amap);
}
function renderRS(){
  var rs=document.getElementById("rs"); rs.innerHTML="";
  for(var i=0;i<S.RS.length;i++){
    var e=S.RS[i];
    var tr=document.createElement("tr");
    var s1 = e.s1 + " (" + (S.prfReady[e.s1]?"‚úì":"‚Ä¶") + ")";
    var s2 = e.s2 + " (" + (S.prfReady[e.s2]?"‚úì":"‚Ä¶") + ")";
    tr.innerHTML = "<td>"+e.idx+"</td><td class='mono'>"+e.op+"</td><td class='mono'>"+s1+"</td><td class='mono'>"+s2+"</td><td class='mono'>"+e.d+"</td><td>"+e.fu+"</td><td>"+(e.done?"<span class='badge b-wb'>WB</span>":(e.issued?"<span class='badge b-exec'>Exec</span>":"<span class='badge b-stall'>Wait</span>"))+"</td>";
    rs.appendChild(tr);
  }
}
function renderROB(){
  var rob=document.getElementById("rob"); rob.innerHTML="";
  for(var i=0;i<S.ROB.length;i++){
    var r=S.ROB[i]; var tr=document.createElement("tr"); if(i===S.commitPtr) tr.classList.add("highlight");
    tr.innerHTML="<td>"+r.idx+"</td><td class='mono'>"+r.op+"</td><td class='mono'>"+r.dst+"</td><td class='mono'>"+r.old+"</td><td>"+(r.wb?"‚úì":"‚Äî")+"</td><td>"+(r.commit?"‚úì":"‚Äî")+"</td>";
    rob.appendChild(tr);
  }
}
function renderStats(){
  var ticks=S.metrics.ticks||1; var ipc=(S.metrics.comm||S.ROB.filter(function(x){return x.commit;}).length)/ticks;
  document.getElementById("ipc").textContent=ipc.toFixed(2);
  document.getElementById("activeRob").textContent=S.ROB.length - S.commitPtr;
  var aluUse = Math.round(100*(S.metrics.alu||0)/ticks), mduUse=Math.round(100*(S.metrics.mdu||0)/ticks);
  document.getElementById("aluUse").textContent=aluUse+"%"; document.getElementById("mduUse").textContent=mduUse+"%";
  document.getElementById("commCount").textContent=S.ROB.filter(function(x){return x.commit;}).length;
}
function renderAll(){
  document.getElementById("cycle").textContent=S.cycle;
  renderRS(); renderROB(); renderPRF(); renderMaps();
  document.getElementById("log").innerHTML=(S.log.map(function(x){return "‚Ä¢ "+x;}).join("<br>"))||"‚Äî";
  renderStats();
}
function resetFromProgram(){
  var progTxt=document.getElementById("prog").value, prog;
  try{ prog=parseProgram(progTxt);}catch(e){alert(e.message);return;}
  S=buildInitialState(prog); HIST=[JSON.parse(JSON.stringify(S))];
  var logs=renameAll(S);
  document.getElementById("renameLog").textContent=logs.join("\n");
  renderAll();
}
function onStep(){
  var before=S.log.length; step(S); HIST.push(JSON.parse(JSON.stringify(S))); renderAll();
  var lines=S.log.slice(before); if(lines.length){ var expl=[]; for(var i=0;i<lines.length;i++){ var L=lines[i]; var E=L;
      if(L.indexOf("Issue@t")===0) E += " ‚Äî RS->FU (operandlar hazƒ±r)";
      if(L.indexOf("WB@t")===0) E += " ‚Äî PRF'e yazƒ±ldƒ±, ROB i≈üaretlendi";
      if(L.indexOf("Commit@t")===0) E += " ‚Äî arch_map g√ºncellendi, eski PR serbest";
      expl.push(E);
  } showToast(expl); }
}
function applyAuto(run){
  var btn=document.getElementById("btnAuto");
  if(run){ if(autoTimer) return; btn.textContent="Pause ‚ùö‚ùö"; var spd=+document.getElementById("speed").value;
    autoTimer=setInterval(function(){ onStep(); if(S.commitPtr>=S.ROB.length){ applyAuto(false);} }, spd);
  } else { btn.textContent="Auto ‚ñ∑"; clearInterval(autoTimer); autoTimer=null; }
}

/* Rename Panel */
var RP=null;
function openRename(){ document.getElementById("overlay").style.display="block"; document.getElementById("renamePanel").style.display="block"; RP=buildInitialState(S.prog); document.getElementById("renameLog").textContent="Ready."; }
function closeRename(){ document.getElementById("overlay").style.display="none"; document.getElementById("renamePanel").style.display="none"; RP=null; }
function renameStepUI(){ if(!RP) return; if(RP.RS.length>=S.prog.length){ document.getElementById("renameLog").textContent+="\nAlready renamed."; return; } var inst=RP.prog[RP.RS.length]; var res=renameOne(RP,inst); document.getElementById("renameLog").textContent += (RP.RS.length===1?"":"\n")+res.line; }
function renameAllUI(){ if(!RP) return; var logs=renameAll(RP); document.getElementById("renameLog").textContent=logs.join("\n"); }
function renameApplyToMain(){ if(!RP) return; S.fmap=RP.fmap; S.free=RP.free; S.prf=RP.prf; S.prfReady=RP.prfReady; S.RS=RP.RS; S.ROB=RP.ROB; S.prfAllocCount=RP.prfAllocCount; renderAll(); closeRename(); }

document.getElementById("btnTheme").onclick=toggleTheme;
document.getElementById("btnLoad").onclick=resetFromProgram;
document.getElementById("btnReset").onclick=resetFromProgram;
document.getElementById("btnPrev").onclick=function(){ if(HIST.length>1){ HIST.pop(); S=JSON.parse(JSON.stringify(HIST[HIST.length-1])); renderAll(); } };
document.getElementById("btnStep").onclick=onStep;
document.getElementById("btnAuto").onclick=function(){ applyAuto(!autoTimer); };
document.getElementById("btnOpenRename").onclick=function(){ openRename(); };
document.getElementById("btnCloseRename").onclick=function(){ closeRename(); };
document.getElementById("btnRenameStep").onclick=function(){ renameStepUI(); };
document.getElementById("btnRenameAll").onclick=function(){ renameAllUI(); };
document.getElementById("btnRenameReset").onclick=function(){ RP=buildInitialState(S.prog); document.getElementById("renameLog").textContent="Ready."; };
document.getElementById("btnRenameApply").onclick=function(){ renameApplyToMain(); };
document.getElementById("overlay").onclick=function(){ closeRename(); };

(function init(){ var saved="dark"; try{saved=localStorage.getItem("pl_theme")||"dark";}catch(e){} document.documentElement.dataset.theme=saved; resetFromProgram(); })();
</script>
</body>
</html>
