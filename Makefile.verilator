# =========================================
# CERES RISC-V â€” Standalone Verilator Makefile
# =========================================
# Completely independent Verilator build system
# - Uses only verilator.json for configuration
# - Uses Python scripts for running
# - No dependencies on other makefiles
# =========================================

# -----------------------------------------
# Paths and Basic Setup
# -----------------------------------------
SHELL := /bin/bash
.SHELLFLAGS := -e -u -o pipefail -c

# Root directory
ROOT_DIR := $(shell pwd)

# Python
PYTHON := python3

# Colors for output
RED     := \033[0;31m
GREEN   := \033[0;32m
YELLOW  := \033[1;33m
CYAN    := \033[0;36m
RESET   := \033[0m

# -----------------------------------------
# Configuration from JSON
# -----------------------------------------
VERILATOR_CONFIG := $(ROOT_DIR)/script/config/verilator.json

# Parse JSON config using Python
define parse_json
$(shell $(PYTHON) -c "import json; cfg=json.load(open('$(VERILATOR_CONFIG)')); print(str(cfg.get('$(1)', {}).get('$(2)', '$(3)')).lower())" 2>/dev/null || echo "$(3)")
endef

# Load all configuration from JSON
MAX_CYCLES       := $(call parse_json,simulation,max_cycles,100000)
BUILD_THREADS    := $(call parse_json,build,threads,$(shell nproc 2>/dev/null || echo 4))
MODE             := $(call parse_json,build,mode,debug)

# Logging flags from JSON
FAST_SIM_JSON    := $(call parse_json,logging,fast_sim,false)
COMMIT_LOG_JSON  := $(call parse_json,logging,commit_trace,true)
BP_LOG_JSON      := $(call parse_json,logging,bp_log,false)
RAM_LOG_JSON     := $(call parse_json,logging,ram_log,false)
UART_LOG_JSON    := $(call parse_json,logging,uart_log,false)

# -----------------------------------------
# Directory Structure
# -----------------------------------------
RTL_DIR        := $(ROOT_DIR)/rtl
INC_DIR        := $(RTL_DIR)/include
BUILD_DIR      := $(ROOT_DIR)/build
OBJ_DIR        := $(BUILD_DIR)/obj_dir
LOG_DIR        := $(BUILD_DIR)/log
TB_DIR         := $(ROOT_DIR)/sim/tb

# Test-specific directories
TEST_NAME      ?= rv32ui-p-add
VERILATOR_LOG  := $(LOG_DIR)/verilator/$(TEST_NAME)

# -----------------------------------------
# RTL Sources
# -----------------------------------------
RTL_LEVEL := ceres_wrapper

# Collect all RTL sources (same as sources.mk)
SV_SOURCES := \
  $(RTL_DIR)/pkg/ceres_param.sv \
  $(wildcard $(RTL_DIR)/core/*.sv) \
  $(wildcard $(RTL_DIR)/core/bus/*.sv) \
  $(wildcard $(RTL_DIR)/core/pmp_pma/*.sv) \
  $(wildcard $(RTL_DIR)/core/stage01_fetch/*.sv) \
  $(wildcard $(RTL_DIR)/core/stage02_decode/*.sv) \
  $(wildcard $(RTL_DIR)/core/stage03_execute/*.sv) \
  $(wildcard $(RTL_DIR)/core/stage03_execute/mul_div/*.sv) \
  $(wildcard $(RTL_DIR)/core/stage03_execute/mul_div/wallace8x8/*.sv) \
  $(wildcard $(RTL_DIR)/core/stage03_execute/mul_div/wallace32x32/*.sv) \
  $(wildcard $(RTL_DIR)/core/stage04_memory/*.sv) \
  $(wildcard $(RTL_DIR)/core/stage05_writeback/*.sv) \
  $(wildcard $(RTL_DIR)/core/mmu/*.sv) \
  $(wildcard $(RTL_DIR)/tracer/*.sv) \
  $(wildcard $(RTL_DIR)/util/*.sv) \
  $(wildcard $(RTL_DIR)/periph/gpio/*.sv) \
  $(wildcard $(RTL_DIR)/periph/plic/*.sv) \
  $(wildcard $(RTL_DIR)/periph/timer/*.sv) \
  $(wildcard $(RTL_DIR)/periph/wdt/*.sv) \
  $(wildcard $(RTL_DIR)/periph/dma/*.sv) \
  $(wildcard $(RTL_DIR)/periph/pwm/*.sv) \
  $(wildcard $(RTL_DIR)/periph/vga/*.sv) \
  $(wildcard $(RTL_DIR)/periph/i2c/*.sv) \
  $(wildcard $(RTL_DIR)/periph/spi/*.sv) \
  $(wildcard $(RTL_DIR)/periph/uart/*.sv) \
  $(wildcard $(RTL_DIR)/ram/*.sv) \
  $(wildcard $(RTL_DIR)/wrapper/*.sv) \
  $(wildcard $(RTL_DIR)/wrapper/*.v)

# Include directories
INC_DIRS := $(INC_DIR)

# Testbench
CPP_TB_FILE := $(TB_DIR)/tb_wrapper.cpp

# Logger source (if needed)
LOGGER_SRC := $(RTL_DIR)/tracer/konata_logger.sv

# -----------------------------------------
# SystemVerilog Defines
# -----------------------------------------
SV_DEFINES :=

# Always enable FST tracing
SV_DEFINES += +define+VM_TRACE_FST

# Apply JSON logging config
ifeq ($(COMMIT_LOG_JSON),true)
  SV_DEFINES += +define+COMMIT_TRACER +define+KONATA_TRACER +define+LOG_COMMIT
endif

ifeq ($(BP_LOG_JSON),true)
  SV_DEFINES += +define+LOG_BP
endif

ifeq ($(RAM_LOG_JSON),true)
  SV_DEFINES += +define+LOG_RAM
endif

ifeq ($(UART_LOG_JSON),true)
  SV_DEFINES += +define+LOG_UART
endif

ifeq ($(FAST_SIM_JSON),true)
  SV_DEFINES += +define+SIM_FAST
endif

# CLI overrides (allow manual control)
ifeq ($(LOG_COMMIT),1)
  SV_DEFINES += +define+LOG_COMMIT
endif

ifeq ($(LOG_BP),1)
  SV_DEFINES += +define+LOG_BP
endif

ifeq ($(LOG_RAM),1)
  SV_DEFINES += +define+LOG_RAM
endif

ifeq ($(LOG_UART),1)
  SV_DEFINES += +define+LOG_UART
endif

ifeq ($(SIM_FAST),1)
  SV_DEFINES += +define+SIM_FAST
endif

ifeq ($(SIM_UART_MONITOR),1)
  SV_DEFINES += +define+SIM_UART_MONITOR
endif

# -----------------------------------------
# Verilator Settings
# -----------------------------------------
VERILATOR := verilator

# Optimization based on MODE
ifeq ($(MODE),debug)
    OPT_LEVEL := -O0
    CFLAGS_DEBUG := -g -DDEBUG
else ifeq ($(MODE),profile)
    OPT_LEVEL := -O2
    CFLAGS_DEBUG := -pg -g
else
    OPT_LEVEL := -O3
    CFLAGS_DEBUG :=
endif

# Trace settings
TRACE_FLAGS := --trace-fst --trace-structs --trace-params --trace-depth 99

# Include paths
VERILATOR_INCLUDES := -I$(INC_DIR)

# Warning suppressions
NO_WARNING := \
    --Wno-fatal \
    --Wno-lint \
    --Wno-WIDTH \
    --Wno-UNDRIVEN \
    --Wno-UNUSED \
    --Wno-UNUSEDPARAM \
    --Wno-UNUSEDSIGNAL \
    --Wno-DECLFILENAME \
    --Wno-UNOPTFLAT \
    --Wno-ENUMVALUE

# Common flags
VERILATOR_COMMON_FLAGS := \
    --top-module $(RTL_LEVEL) \
    $(VERILATOR_INCLUDES) \
    --timing \
    --x-assign fast \
    --x-initial 0 \
    --Mdir $(OBJ_DIR)

# Build flags
VERILATOR_BUILD_FLAGS := \
    --cc \
    --exe $(CPP_TB_FILE) \
    --build \
    -j $(BUILD_THREADS) \
    --output-split 20000 \
    --output-split-cfuncs 5000 \
    $(TRACE_FLAGS) \
    --CFLAGS "$(OPT_LEVEL) $(CFLAGS_DEBUG) -std=c++17 -Wall -Wextra -Wno-unused-parameter" \
    --LDFLAGS "-lm"

# Binary output
RUN_BIN := $(OBJ_DIR)/V$(RTL_LEVEL)

# -----------------------------------------
# Python Runner
# -----------------------------------------
VERILATOR_RUNNER := $(ROOT_DIR)/script/python/makefile/verilator_runner.py

# Memory file search paths
MEM_DIRS := $(BUILD_DIR)/tests/riscv-tests/mem \
            $(BUILD_DIR)/tests/riscv-arch-test/mem \
            $(BUILD_DIR)/tests/imperas/mem \
            $(BUILD_DIR)/tests/bench/mem

# Runner arguments
RUNNER_ARGS := \
    --test $(TEST_NAME) \
    --bin-path $(RUN_BIN) \
    --log-dir $(VERILATOR_LOG) \
    --mem-dirs "$(MEM_DIRS)" \
    --build-dir $(BUILD_DIR)/tests

# Optional arguments
ifdef MAX_CYCLES
    RUNNER_ARGS += --max-cycles $(MAX_CYCLES)
endif

ifdef MEM_FILE
    RUNNER_ARGS += --mem-file $(MEM_FILE)
endif

ifeq ($(TRACE),0)
    RUNNER_ARGS += --no-trace
endif

# -----------------------------------------
# Test List Files
# -----------------------------------------
RESULTS_DIR ?= $(ROOT_DIR)/results
FLIST ?= $(ROOT_DIR)/sim/test/riscv_test_list.flist
PASS_LIST_FILE := $(RESULTS_DIR)/logs/verilator_passed.txt
FAIL_LIST_FILE := $(RESULTS_DIR)/logs/verilator_failed.txt

# -----------------------------------------
# Targets
# -----------------------------------------
.PHONY: all build run clean help show-config dirs run-flist isa arch bench

# Default target
all: build

# Create directories
dirs:
	@mkdir -p "$(BUILD_DIR)" "$(OBJ_DIR)" "$(LOG_DIR)" "$(VERILATOR_LOG)"

# Show current configuration
show-config:
	@echo -e "$(CYAN)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(RESET)"
	@echo -e "$(CYAN)  Verilator Configuration$(RESET)"
	@echo -e "$(CYAN)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(RESET)"
	@echo -e "  Config file     : $(VERILATOR_CONFIG)"
	@echo -e "  Test name       : $(GREEN)$(TEST_NAME)$(RESET)"
	@echo -e "  Max cycles      : $(MAX_CYCLES)"
	@echo -e "  Build threads   : $(BUILD_THREADS)"
	@echo -e "  Mode            : $(MODE)"
	@echo -e "  Optimization    : $(OPT_LEVEL)"
	@echo -e "$(CYAN)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(RESET)"
	@echo -e "$(CYAN)  Logging Flags (from JSON)$(RESET)"
	@echo -e "$(CYAN)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(RESET)"
	@echo -e "  Commit trace    : $(COMMIT_LOG_JSON)"
	@echo -e "  BP log          : $(BP_LOG_JSON)"
	@echo -e "  RAM log         : $(RAM_LOG_JSON)"
	@echo -e "  UART log        : $(UART_LOG_JSON)"
	@echo -e "  Fast sim        : $(FAST_SIM_JSON)"
	@echo -e "$(CYAN)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(RESET)"
	@echo -e "$(CYAN)  SystemVerilog Defines$(RESET)"
	@echo -e "$(CYAN)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(RESET)"
	@echo -e "  $(SV_DEFINES)"
	@echo -e "$(CYAN)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(RESET)"

# Build Verilator model
build: dirs
	@echo -e "$(GREEN)[VERILATOR BUILD]$(RESET) Mode: $(MODE), Threads: $(BUILD_THREADS)"
	@echo -e "$(CYAN)[INFO]$(RESET) Defines: $(SV_DEFINES)"
	$(VERILATOR) \
		$(SV_SOURCES) $(LOGGER_SRC) \
		$(VERILATOR_COMMON_FLAGS) \
		$(VERILATOR_BUILD_FLAGS) \
		$(NO_WARNING) \
		$(SV_DEFINES)
	@echo -e "$(GREEN)[SUCCESS]$(RESET) Binary: $(RUN_BIN)"

# Run simulation
run: build
	@echo -e "$(GREEN)[RUN SIMULATION]$(RESET) Test: $(TEST_NAME)"
	@$(PYTHON) $(VERILATOR_RUNNER) $(RUNNER_ARGS)

# Clean build artifacts
clean:
	@echo -e "$(RED)[CLEAN]$(RESET) Removing build artifacts..."
	@rm -rf "$(OBJ_DIR)"
	@rm -rf "$(LOG_DIR)/verilator"
	@echo -e "$(GREEN)[DONE]$(RESET) Clean complete"

# Open waveform
wave:
	@if [ -f "$(VERILATOR_LOG)/waveform.fst" ]; then \
		echo -e "$(CYAN)[WAVE]$(RESET) Opening GTKWave..."; \
		gtkwave "$(VERILATOR_LOG)/waveform.fst" & \
	else \
		echo -e "$(RED)[ERROR]$(RESET) Waveform not found: $(VERILATOR_LOG)/waveform.fst"; \
	fi

# ============================================================
# Batch Test Execution from File
# ============================================================
run-flist:
	@if [ ! -f "$(FLIST)" ]; then \
		echo -e "$(RED)[ERROR]$(RESET) Test list file not found: $(FLIST)"; \
		exit 1; \
	fi
	@mkdir -p "$(RESULTS_DIR)/logs"
	@echo -n "" > $(PASS_LIST_FILE)
	@echo -n "" > $(FAIL_LIST_FILE)
	@echo -e "$(GREEN)Running tests from list file:$(RESET) $(FLIST)"
	@echo -e "$(CYAN)Output directory:$(RESET) $(LOG_DIR)/verilator/"
	@PASS=0; FAIL=0; TOTAL=0; \
	while IFS= read -r test || [ -n "$${test}" ]; do \
		test="$${test%% }"; test="$${test## }"; \
		if echo "$${test}" | grep -E '^\s*#' >/dev/null || [ -z "$${test}" ]; then continue; fi; \
		TOTAL=$$(( $${TOTAL} + 1 )); \
		echo -e ""; \
		echo -e "$(YELLOW)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(RESET)"; \
		echo -e "$(CYAN)[FLIST] Test $${TOTAL}: $${test}$(RESET)"; \
		echo -e "$(YELLOW)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(RESET)"; \
		mkdir -p "$(LOG_DIR)/verilator/$${test}"; \
		if $(MAKE) -f Makefile.verilator run TEST_NAME=$${test} > "$(LOG_DIR)/verilator/$${test}/summary.log" 2>&1; then \
			PASS=$$(( $${PASS} + 1 )); \
			echo "$${test}" >> "$(PASS_LIST_FILE)"; \
			echo -e "$(GREEN)âœ… $${test} PASSED$(RESET)"; \
		else \
			TEST_EXIT=$$?; \
			FAIL=$$(( $${FAIL} + 1 )); \
			echo "$${test}" >> "$(FAIL_LIST_FILE)"; \
			echo -e "$(RED)âœ— $${test} FAILED (exit code: $${TEST_EXIT})$(RESET)"; \
			echo -e "$(YELLOW)  â†³ Log: $(LOG_DIR)/verilator/$${test}/summary.log$(RESET)"; \
		fi; \
	done < "$(FLIST)"; \
	echo -e ""; \
	echo -e "$(YELLOW)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(RESET)"; \
	echo -e "$(GREEN) Batch Test Summary$(RESET)"; \
	echo -e "$(YELLOW)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(RESET)"; \
	echo -e "$(GREEN)âœ… Passed: $${PASS}$(RESET)"; \
	echo -e "$(RED)âœ— Failed: $${FAIL}$(RESET)"; \
	echo -e "$(CYAN)ðŸ“Š Total:  $${TOTAL}$(RESET)"; \
	echo -e "$(YELLOW)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(RESET)"; \
	echo -e "$(GREEN)Passed tests:$(RESET) $(PASS_LIST_FILE)"; \
	echo -e "$(RED)Failed tests:$(RESET) $(FAIL_LIST_FILE)"; \
	if [ $${FAIL} -gt 0 ]; then \
		echo -e "$(RED)âš   $${FAIL} test(s) failed$(RESET)"; \
		exit 1; \
	else \
		echo -e "$(GREEN)ðŸŽ‰ All tests passed!$(RESET)"; \
	fi

# Shortcut targets for common test suites
isa:
	@$(MAKE) -f Makefile.verilator run-flist FLIST=$(ROOT_DIR)/sim/test/riscv_test_list.flist

arch:
	@$(MAKE) -f Makefile.verilator run-flist FLIST=$(ROOT_DIR)/sim/test/riscv_arch_test_list.flist

bench:
	@$(MAKE) -f Makefile.verilator run-flist FLIST=$(ROOT_DIR)/sim/test/benchmark_test_list.flist

# Help
help:
	@echo -e ""
	@echo -e "$(GREEN)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(RESET)"
	@echo -e "$(GREEN)  CERES RISC-V â€” Standalone Verilator Makefile$(RESET)"
	@echo -e "$(GREEN)â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”$(RESET)"
	@echo -e ""
	@echo -e "$(YELLOW)Configuration:$(RESET)"
	@echo -e "  All settings are read from: $(CYAN)$(VERILATOR_CONFIG)$(RESET)"
	@echo -e ""
	@echo -e "$(YELLOW)Targets:$(RESET)"
	@echo -e "  $(GREEN)build$(RESET)          - Build Verilator C++ model"
	@echo -e "  $(GREEN)run$(RESET)            - Build and run simulation"
	@echo -e "  $(GREEN)run-flist$(RESET)      - Run tests from FLIST file"
	@echo -e "  $(GREEN)isa$(RESET)            - Run all ISA compliance tests"
	@echo -e "  $(GREEN)arch$(RESET)           - Run all architecture tests"
	@echo -e "  $(GREEN)bench$(RESET)          - Run all benchmark tests"
	@echo -e "  $(GREEN)clean$(RESET)          - Clean build artifacts"
	@echo -e "  $(GREEN)wave$(RESET)           - Open waveform in GTKWave"
	@echo -e "  $(GREEN)show-config$(RESET)    - Show current configuration"
	@echo -e "  $(GREEN)help$(RESET)           - Show this help"
	@echo -e ""
	@echo -e "$(YELLOW)CLI Parameters:$(RESET)"
	@echo -e "  $(CYAN)TEST_NAME$(RESET)=<name>      - Test to run (default: rv32ui-p-add)"
	@echo -e "  $(CYAN)MAX_CYCLES$(RESET)=<n>        - Override max cycles"
	@echo -e "  $(CYAN)MODE$(RESET)=<debug|release>  - Build mode"
	@echo -e "  $(CYAN)MEM_FILE$(RESET)=<path>       - Specific memory file"
	@echo -e "  $(CYAN)TRACE$(RESET)=0               - Disable waveform trace"
	@echo -e ""
	@echo -e "$(YELLOW)Logging CLI Overrides:$(RESET)"
	@echo -e "  $(CYAN)LOG_COMMIT$(RESET)=1          - Enable commit logging"
	@echo -e "  $(CYAN)LOG_BP$(RESET)=1              - Enable branch predictor logging"
	@echo -e "  $(CYAN)LOG_RAM$(RESET)=1             - Enable RAM logging"
	@echo -e "  $(CYAN)LOG_UART$(RESET)=1            - Enable UART logging"
	@echo -e "  $(CYAN)SIM_FAST$(RESET)=1            - Enable fast simulation mode"
	@echo -e "  $(CYAN)SIM_UART_MONITOR$(RESET)=1   - Enable UART monitor"
	@echo -e ""
	@echo -e "$(YELLOW)Examples:$(RESET)"
	@echo -e "  $(CYAN)# Single test$(RESET)"
	@echo -e "  make -f Makefile.verilator run TEST_NAME=rv32ui-p-add"
	@echo -e "  make -f Makefile.verilator run TEST_NAME=rv32ui-p-add LOG_BP=1"
	@echo -e ""
	@echo -e "  $(CYAN)# Batch tests$(RESET)"
	@echo -e "  make -f Makefile.verilator isa"
	@echo -e "  make -f Makefile.verilator run-flist FLIST=custom_tests.flist"
	@echo -e ""
	@echo -e "  $(CYAN)# Configuration$(RESET)"
	@echo -e "  make -f Makefile.verilator show-config"
	@echo -e "  make -f Makefile.verilator run MODE=release MAX_CYCLES=50000"
	@echo -e ""
