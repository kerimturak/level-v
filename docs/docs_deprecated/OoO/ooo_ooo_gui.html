<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OoO Core Simulator — Step-by-Step</title>
<style>
  :root{--bg:#0b0f14;--fg:#e8eef6;--muted:#9fb0c3;--acc:#67d2ff;--ok:#6ee7a8;--warn:#ffd166;--err:#ff6b6b;--card:#121822;--chip:#1a2230;}
  body{background:var(--bg);color:var(--fg);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;padding:0;line-height:1.4}
  header{padding:16px 24px;border-bottom:1px solid #202a39;display:flex;justify-content:space-between;align-items:center}
  header h1{font-size:18px;margin:0}
  .container{padding:16px 24px;display:grid;grid-template-columns: 1fr 1fr;gap:16px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .card{background:var(--card);border:1px solid #202a39;border-radius:12px;padding:12px}
  .card h3{margin:0 0 8px 0;font-size:14px;color:var(--muted)}
  button{background:var(--chip);border:1px solid #2a3447;color:var(--fg);border-radius:10px;padding:8px 12px;cursor:pointer}
  button.primary{background:var(--acc);color:#000}
  button.warn{background:var(--warn);color:#000}
  button:disabled{opacity:.5;cursor:not-allowed}
  .pill{display:inline-block;background:#223049;color:var(--fg);padding:2px 8px;border-radius:999px;font-size:12px}
  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{border-bottom:1px solid #223049;padding:6px 8px;text-align:left;vertical-align:top}
  tr.highlight td{background:#182232}
  code{background:#0d131b;border:1px solid #1e2a3c;padding:2px 6px;border-radius:6px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .kv{display:flex;flex-wrap:wrap;gap:8px}
  .kv div{background:var(--chip);border:1px solid #2a3447;border-radius:8px;padding:6px 8px;font-size:12px}
  .legend{display:flex;gap:8px;align-items:center}
  .dot{width:10px;height:10px;border-radius:50%}
  .dot.exec{background:var(--acc)}
  .dot.wb{background:var(--ok)}
  .dot.commit{background:var(--warn)}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  .small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header>
  <h1>OoO Core Simulator — Step-by-Step</h1>
  <div class="row">
    <div>Cycle: <span id="cycle" class="pill mono">0</span></div>
    <button id="btnPrev">◀ Prev</button>
    <button id="btnStep" class="primary">Step ▶</button>
    <button id="btnAuto">Auto ▷</button>
    <button id="btnReset" class="warn">Reset ↺</button>
  </div>
</header>

<div class="container">
  <div class="card">
    <h3>Program & μArch</h3>
    <div class="grid2">
      <div>
        <div class="small">Edit instruction list (OP src1, src2 -> dst). Valid OP: ADD, MUL</div>
        <textarea id="prog" rows="8" style="width:100%;background:#0d131b;color:var(--fg);border:1px solid #1e2a3c;border-radius:8px;padding:8px" class="mono">MUL R1, R2 -> R3
ADD R3, R4 -> R5
ADD R2, R6 -> R7
ADD R8, R9 -> R10
MUL R7, R10 -> R11
ADD R5, R11 -> R5</textarea>
        <div class="row" style="margin-top:8px">
          <button id="btnLoad">Load Program</button>
          <span class="small">ALU(ADD)=1 cyc, MDU(MUL)=3 cyc, issue/commit=2, dispatch=1/cyc</span>
        </div>
      </div>
      <div>
        <div class="kv">
          <div>ALU units: <span id="aluN" class="mono">1</span></div>
          <div>MDU units: <span id="mduN" class="mono">1</span></div>
          <div>Issue width: <span class="mono">2</span></div>
          <div>Commit width: <span class="mono">2</span></div>
          <div>Dispatch/cyc: <span class="mono">1</span></div>
        </div>
        <div class="legend" style="margin-top:8px">
          <span class="dot exec"></span><span class="small">Executing</span>
          <span class="dot wb"></span><span class="small">Writeback</span>
          <span class="dot commit"></span><span class="small">Commit</span>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>Functional Units</h3>
    <table>
      <thead><tr><th>Unit</th><th>Busy</th><th>Currently Executing</th></tr></thead>
      <tbody id="units"></tbody>
    </table>
  </div>

  <div class="card">
    <h3>ROB (Reorder Buffer) — In-Order Commit</h3>
    <table>
      <thead><tr><th>#</th><th>Instr</th><th>Dst Phys</th><th>State</th><th>Times (D/Is/Ex/WB/C)</th></tr></thead>
      <tbody id="rob"></tbody>
    </table>
  </div>

  <div class="card">
    <h3>Issue Queue (IQ)</h3>
    <table>
      <thead><tr><th>#</th><th>Instr</th><th>Src Phys</th><th>Ready?</th></tr></thead>
      <tbody id="iq"></tbody>
    </table>
  </div>

  <div class="card">
    <h3>RAT (Register Alias Table) — current mapping</h3>
    <div id="rat" class="kv mono"></div>
  </div>

  <div class="card">
    <h3>Event Log (this cycle)</h3>
    <div id="log" class="mono small"></div>
  </div>
</div>

<script>
// ===== Model =====
const LAT = { ADD:1, MUL:3 };
const FU  = { ADD:"ALU", MUL:"MDU" };
const UNITS = { ALU:1, MDU:1 };
const ISSUE_WIDTH=2, COMMIT_WIDTH=2, DISPATCH_PER_CYCLE=1;
const ARCH_N=64;

function parseProgram(text){
  const lines = text.split(/[\r\n]+/).map(s=>s.trim()).filter(Boolean);
  const out = [];
  for(const [i,line] of lines.entries()){
    // format: OP R1, R2 -> R3
    const m = line.match(/^([A-Z]+)\s+([Rr]\d+)\s*,\s*([Rr]\d+)\s*->\s*([Rr]\d+)$/);
    if(!m) throw new Error(`Line ${i+1}: bad syntax "${line}"`);
    const op = m[1].toUpperCase();
    if(!(op in FU)) throw new Error(`Line ${i+1}: unsupported OP "${op}"`);
    out.push({op, src:["R"+(+m[2].slice(1)), "R"+(+m[3].slice(1))], dst:"R"+(+m[4].slice(1))});
  }
  return out;
}

function buildInitialState(program){
  // RAT & free list
  const RAT = {}; const readyTime={}; const free=[];
  for(let i=1;i<=ARCH_N;i++){ RAT["R"+i]="p"+i; readyTime["p"+i]=0; }
  for(let i=ARCH_N+1;i<=512;i++) free.push("p"+i);

  // Dispatch all (1 per cycle -> dispatchCycle increments by 1 each)
  let cycle=1;
  const ROB=[];
  for(let i=0;i<program.length;i++){
    const {op,src,dst} = program[i];
    const srcP = [RAT[src[0]], RAT[src[1]]];
    const dstP = free.shift();
    ROB.push({
      idx:i+1, op, src, dst,
      srcP, dstP, fu:FU[op],
      dispatch: cycle, issue:null, start:null, end:null, wb:null, commit:null,
      state:"dispatched"
    });
    RAT[dst]=dstP; readyTime[dstP]=1e9; // new phys not ready
    cycle += Math.ceil(1/DISPATCH_PER_CYCLE);
  }

  return {
    cycle:0,
    ROB, RAT, readyTime,
    inflight:{ALU:0, MDU:0},
    execEnds:{}, wbs:{},
    commitPtr:0,
    log:[]
  };
}

function isReady(inst, t, readyTime){
  return readyTime[inst.srcP[0]]<=t && readyTime[inst.srcP[1]]<=t;
}

function step(state){
  const log=[]; const t=state.cycle+1;

  // 1) Exec ends -> free & schedule WB
  const dueExec = state.execEnds[t] || [];
  for(const inst of dueExec){
    state.inflight[inst.fu]--;
    (state.wbs[t] ||= []).push(inst);
    log.push(`ExecEnd@t${t}: i${inst.idx}`);
  }
  delete state.execEnds[t];

  // 2) Perform WB
  const doWb = state.wbs[t] || [];
  for(const inst of doWb){
    state.readyTime[inst.dstP] = t;
    inst.wb = t;
    if(inst.state!=="committed") inst.state="written-back";
    log.push(`WB@t${t}: i${inst.idx} -> ${inst.dstP}`);
  }
  delete state.wbs[t];

  // 3) Issue (up to width), in any order from ROB that hasn't issued
  let issued=0;
  for(const inst of state.ROB){
    if(inst.issue!=null) continue;
    if(inst.dispatch>t) continue;
    if(state.inflight[inst.fu] >= UNITS[inst.fu]) continue;
    if(!isReady(inst, t, state.readyTime)) continue;
    // grant
    inst.issue = t; inst.start = t; inst.end = t + LAT[inst.op];
    state.inflight[inst.fu]++;
    (state.execEnds[inst.end] ||= []).push(inst);
    inst.state="executing";
    log.push(`Issue@t${t}: i${inst.idx} -> ${inst.fu}`);
    issued++; if(issued>=ISSUE_WIDTH) break;
  }

  // 4) Commit (in-order), up to width
  let committed=0;
  while(committed<COMMIT_WIDTH && state.commitPtr < state.ROB.length){
    const head = state.ROB[state.commitPtr];
    if(head.wb!=null && head.wb<=t){
      head.commit=t; head.state="committed";
      state.commitPtr++; committed++;
      log.push(`Commit@t${t}: i${head.idx}`);
    }else break;
  }

  state.cycle=t;
  state.log = log;
  return state;
}

// ===== UI =====
let STATE = null;
let HIST = []; // snapshots per cycle for Prev

function snapshot(s){
  return JSON.parse(JSON.stringify(s));
}

function render(){
  document.getElementById("cycle").textContent = STATE.cycle;
  // Units
  const units = document.getElementById("units");
  units.innerHTML = "";
  for(const u of ["ALU","MDU"]){
    const tr = document.createElement("tr");
    const busy = STATE.inflight[u];
    const exec = [];
    for(const inst of STATE.ROB){
      if(inst.state==="executing" && inst.fu===u) exec.push(`#${inst.idx} [t${inst.start}..t${inst.end})`);
    }
    tr.innerHTML = `<td>${u}</td><td>${busy}</td><td class="mono">${exec.join(", ")||"—"}</td>`;
    units.appendChild(tr);
  }
  // ROB
  const rob = document.getElementById("rob");
  rob.innerHTML="";
  for(const inst of STATE.ROB){
    const tr = document.createElement("tr");
    if(STATE.commitPtr<STATE.ROB.length && STATE.ROB[STATE.commitPtr].idx===inst.idx) tr.classList.add("highlight");
    const stat = inst.state;
    const times = `D${inst.dispatch||"-"}/I${inst.issue||"-"}/E${inst.start||"-"}-${inst.end||"-"}/W${inst.wb||"-"}/C${inst.commit||"-"}`;
    tr.innerHTML = `<td>${inst.idx}</td>
      <td class="mono">${inst.op} ${inst.src[0]}, ${inst.src[1]} -> ${inst.dst}</td>
      <td class="mono">${inst.dstP}</td>
      <td>${stat}</td>
      <td class="mono">${times}</td>`;
    rob.appendChild(tr);
  }
  // IQ
  const iq = document.getElementById("iq");
  iq.innerHTML="";
  for(const inst of STATE.ROB){
    if(inst.issue!=null) continue;
    if(STATE.cycle < inst.dispatch) continue;
    const ready = isReady(inst, STATE.cycle, STATE.readyTime);
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${inst.idx}</td>
      <td class="mono">${inst.op} ${inst.src[0]}, ${inst.src[1]} -> ${inst.dst}</td>
      <td class="mono">${inst.srcP.join(", ")}</td>
      <td>${ready?'<span class="pill" style="background:#0f2f1f;border:1px solid #254; color:#9f9">READY</span>':'<span class="pill" style="background:#2f1f1f;border:1px solid #542; color:#f99">WAIT</span>'}</td>`;
    iq.appendChild(tr);
  }
  // RAT (only show regs touched by program to keep compact)
  const ratDiv = document.getElementById("rat");
  ratDiv.innerHTML="";
  const touched = new Set();
  for(const inst of STATE.ROB){
    touched.add(inst.dst);
    touched.add(inst.src[0]);
    touched.add(inst.src[1]);
  }
  const list = Array.from(touched).sort((a,b)=>Number(a.slice(1))-Number(b.slice(1)));
  for(const r of list){
    const d = document.createElement("div");
    d.textContent = `${r}→${STATE.RAT[r]}`;
    ratDiv.appendChild(d);
  }
  // Log
  document.getElementById("log").innerHTML = STATE.log.map(x=>`• ${x}`).join("<br>");
}

function resetFromProgram(){
  const progTxt = document.getElementById("prog").value;
  let prog;
  try{
    prog = parseProgram(progTxt);
  }catch(e){
    alert(e.message); return;
  }
  STATE = buildInitialState(prog);
  HIST = [snapshot(STATE)];
  render();
}

let autoTimer=null;
function setAuto(run){
  const btnAuto = document.getElementById("btnAuto");
  if(run){
    if(autoTimer) return;
    btnAuto.textContent = "Pause ❚❚";
    autoTimer = setInterval(()=>{
      step(STATE);
      HIST.push(snapshot(STATE));
      render();
      // stop if all committed
      if(STATE.commitPtr >= STATE.ROB.length){
        setAuto(false);
      }
    }, 500);
  }else{
    btnAuto.textContent = "Auto ▷";
    clearInterval(autoTimer); autoTimer=null;
  }
}

document.getElementById("btnLoad").onclick = resetFromProgram;
document.getElementById("btnReset").onclick = resetFromProgram;
document.getElementById("btnStep").onclick = ()=>{
  step(STATE);
  HIST.push(snapshot(STATE));
  render();
};
document.getElementById("btnPrev").onclick = ()=>{
  if(HIST.length>1){
    HIST.pop();
    STATE = snapshot(HIST[HIST.length-1]);
    render();
  }
};
document.getElementById("btnAuto").onclick = ()=> setAuto(!autoTimer);

// init
resetFromProgram();
</script>
</body>
</html>
