<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>PipelineLens Pro â€” Advanced Out-of-Order CPU Simulator</title>
<style>
:root[data-theme="dark"]{
  --bg:#0a0e14; --fg:#e6edf3; --muted:#8b949e; --acc:#58a6ff; --ok:#3fb950; --warn:#d29922; --err:#f85149;
  --card:#161b22; --chip:#21262d; --line:#30363d; --ink:#0d1117; --border:#30363d;
  --hover:#1f6feb; --select:#388bfd26;
}
:root[data-theme="light"]{
  --bg:#ffffff; --fg:#24292f; --muted:#57606a; --acc:#0969da; --ok:#1a7f37; --warn:#9a6700; --err:#cf222e;
  --card:#f6f8fa; --chip:#ffffff; --line:#d0d7de; --ink:#f6f8fa; --border:#d0d7de;
  --hover:#0969da; --select:#ddf4ff;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  background:var(--bg);color:var(--fg);
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif;
  line-height:1.5;
}
header{
  padding:16px 24px;border-bottom:1px solid var(--border);
  display:flex;gap:16px;align-items:center;justify-content:space-between;flex-wrap:wrap;
  background:var(--card);position:sticky;top:0;z-index:100;
}
h1{font-size:20px;font-weight:600;display:flex;align-items:center;gap:8px}
h2{font-size:16px;font-weight:600;margin-bottom:12px;color:var(--fg)}
h3{font-size:14px;font-weight:600;margin-bottom:8px;color:var(--muted)}
.small{font-size:12px;color:var(--muted)}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
.pill{
  display:inline-flex;align-items:center;gap:4px;
  background:var(--chip);border:1px solid var(--line);
  padding:4px 10px;border-radius:6px;font-size:12px;
}
button{
  background:var(--chip);border:1px solid var(--line);color:var(--fg);
  border-radius:6px;padding:8px 14px;cursor:pointer;font-size:13px;
  transition:all 0.2s;font-weight:500;
}
button:hover{background:var(--line);transform:translateY(-1px)}
button.primary{background:var(--acc);color:#fff;border-color:var(--acc)}
button.primary:hover{opacity:0.9}
button.warn{background:var(--warn);color:#000;border-color:var(--warn)}
button.success{background:var(--ok);color:#fff;border-color:var(--ok)}
button:disabled{opacity:.5;cursor:not-allowed;transform:none}
select{
  background:var(--chip);border:1px solid var(--line);color:var(--fg);
  border-radius:6px;padding:8px 12px;cursor:pointer;font-size:13px;
}
.container{
  padding:24px;display:grid;
  grid-template-columns:repeat(12, 1fr);gap:16px;max-width:1800px;margin:0 auto;
}
.card{
  background:var(--card);border:1px solid var(--border);
  border-radius:8px;padding:16px;
}
.card.span-6{grid-column:span 6}
.card.span-4{grid-column:span 4}
.card.span-8{grid-column:span 8}
.card.span-12{grid-column:span 12}
@media(max-width:1200px){
  .card.span-6,.card.span-4,.card.span-8{grid-column:span 12}
}
.tabs{display:flex;gap:4px;margin-bottom:16px;border-bottom:1px solid var(--line)}
.tab{
  padding:8px 16px;cursor:pointer;border-bottom:2px solid transparent;
  transition:all 0.2s;font-size:13px;font-weight:500;
}
.tab:hover{background:var(--chip)}
.tab.active{border-bottom-color:var(--acc);color:var(--acc)}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.kv{display:flex;flex-wrap:wrap;gap:6px}
.kv-item{
  background:var(--chip);border:1px solid var(--line);
  border-radius:6px;padding:6px 10px;font-size:12px;
  transition:all 0.2s;cursor:default;
}
.kv-item:hover{background:var(--line);transform:scale(1.05)}

table{width:100%;border-collapse:collapse;font-size:13px}
thead{background:var(--chip);position:sticky;top:61px;z-index:10}
th{
  padding:10px 12px;text-align:left;font-weight:600;
  border-bottom:2px solid var(--line);color:var(--muted);
}
td{
  padding:10px 12px;border-bottom:1px solid var(--line);
  vertical-align:middle;
}
tr:hover td{background:var(--select)}
tr.highlight td{background:var(--select);font-weight:500}
tr.ready td{background:color-mix(in srgb, var(--ok) 10%, transparent)}
tr.blocked td{background:color-mix(in srgb, var(--err) 10%, transparent)}

textarea{
  width:100%;background:var(--ink);color:var(--fg);
  border:1px solid var(--line);border-radius:6px;padding:12px;
  font-family:ui-monospace,monospace;font-size:13px;line-height:1.6;
  resize:vertical;min-height:200px;
}
.code-editor{position:relative}
.line-numbers{
  position:absolute;left:12px;top:12px;
  color:var(--muted);user-select:none;pointer-events:none;
  line-height:1.6;font-size:13px;
}

.legend{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.legend-item{display:flex;align-items:center;gap:6px;font-size:12px}
.dot{width:12px;height:12px;border-radius:3px;flex-shrink:0}
.dot.dispatch{background:#58a6ff}
.dot.issue{background:#d29922}
.dot.exec{background:#8b5cf6}
.dot.wb{background:#3fb950}
.dot.commit{background:#f778ba}
.dot.stall{background:#f85149}
.dot.idle{background:var(--chip);border:1px solid var(--line)}

.badge{
  display:inline-block;padding:3px 8px;border-radius:4px;
  font-size:11px;font-weight:600;border:1px solid;
}
.badge-dispatch{background:#1f2937;color:#58a6ff;border-color:#1e3a8a}
.badge-issue{background:#2d1f0e;color:#fbbf24;border-color:#78350f}
.badge-exec{background:#2e1065;color:#a78bfa;border-color:#4c1d95}
.badge-wb{background:#14532d;color:#4ade80;border-color:#166534}
.badge-commit{background:#4c0519;color:#fb7185;border-color:#9f1239}
.badge-stall{background:#450a0a;color:#f87171;border-color:#7f1d1d}
.badge-ready{background:#14532d;color:#4ade80;border-color:#166534}
.badge-waiting{background:#450a0a;color:#fca5a5;border-color:#7f1d1d}

.timeline{
  display:grid;
  grid-template-columns:140px repeat(auto-fill, minmax(16px, 1fr));
  gap:3px;align-items:center;margin-bottom:8px;
}
.tl-label{font-size:12px;color:var(--muted);font-weight:500}
.tl-cell{height:20px;border-radius:3px;position:relative;transition:all 0.2s}
.tl-cell:hover{transform:scale(1.1);z-index:5}
.tl-d{background:#58a6ff}
.tl-i{background:#d29922}
.tl-e{background:#8b5cf6}
.tl-w{background:#3fb950}
.tl-c{background:#f778ba}
.tl-s{background:#f85149}
.tl-n{background:var(--chip);border:1px solid var(--line)}

.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px}
.stat-card{
  background:var(--chip);border:1px solid var(--line);
  border-radius:6px;padding:12px;text-align:center;
  transition:all 0.2s;
}
.stat-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.1)}
.stat-label{font-size:11px;color:var(--muted);text-transform:uppercase;margin-bottom:4px}
.stat-value{font-size:24px;font-weight:600;font-family:ui-monospace,monospace}

.help-panel{
  background:color-mix(in srgb, var(--acc) 10%, var(--card));
  border:1px solid var(--acc);border-radius:6px;padding:12px;margin-bottom:16px;
}
.help-panel h4{font-size:13px;margin-bottom:8px;color:var(--acc)}
.help-panel ul{margin-left:20px}
.help-panel li{font-size:12px;margin-bottom:4px}

.modal{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);
  z-index:1000;align-items:center;justify-content:center;
}
.modal.show{display:flex}
.modal-content{
  background:var(--card);border:1px solid var(--border);
  border-radius:8px;padding:24px;max-width:600px;width:90%;
  max-height:80vh;overflow:auto;
}

#instrDetail{
  position:fixed;right:16px;bottom:16px;z-index:200;
  width:400px;max-height:60vh;overflow:auto;
  box-shadow:0 8px 24px rgba(0,0,0,0.3);
}
@media(max-width:768px){
  #instrDetail{width:90%;right:5%;left:5%}
}

.progress-bar{
  height:8px;background:var(--line);border-radius:4px;overflow:hidden;
  margin-top:8px;
}
.progress-fill{
  height:100%;background:var(--acc);
  transition:width 0.3s;border-radius:4px;
}

.tooltip{
  position:absolute;background:var(--ink);border:1px solid var(--line);
  padding:8px 12px;border-radius:6px;font-size:12px;
  pointer-events:none;z-index:1000;display:none;
  box-shadow:0 4px 12px rgba(0,0,0,0.3);
}

.example-btn{
  padding:6px 12px;font-size:12px;
  background:var(--chip);border:1px solid var(--line);
  border-radius:4px;cursor:pointer;
  transition:all 0.2s;
}
.example-btn:hover{background:var(--line)}

.hazard-warning{
  background:color-mix(in srgb, var(--warn) 15%, transparent);
  border-left:3px solid var(--warn);padding:8px 12px;
  border-radius:4px;margin:8px 0;font-size:12px;
}

.dependency-graph{
  display:flex;flex-direction:column;gap:8px;
  padding:12px;background:var(--ink);border-radius:6px;
}
.dep-node{
  display:flex;align-items:center;gap:8px;
  padding:8px;background:var(--chip);border:1px solid var(--line);
  border-radius:4px;font-size:12px;
}
.dep-arrow{color:var(--muted);font-size:16px}
</style>
</head>
<body>
<header>
  <div class="row">
    <h1>
      <span style="font-size:24px">âš¡</span>
      PipelineLens Pro
    </h1>
    <span class="pill">
      <span style="color:var(--muted)">Config:</span>
      ALU=<strong>1cy</strong> | MDU=<strong>3cy</strong> | Issue=<strong>2</strong> | Commit=<strong>2</strong>
    </span>
  </div>
  <div class="row">
    <div class="pill">
      <strong>Cycle:</strong> <span id="cycle" class="mono">0</span>
    </div>
    <button id="btnPrev">â—€ Geri</button>
    <button id="btnStep" class="primary">AdÄ±m â–¶</button>
    <button id="btnAuto">Otomatik â–¶â–¶</button>
    <select id="speed">
      <option value="1000">Ã—0.5</option>
      <option value="700">Ã—1</option>
      <option value="350">Ã—2</option>
      <option value="175">Ã—4</option>
    </select>
    <button id="btnReset" class="warn">â†º SÄ±fÄ±rla</button>
    <button id="btnHelp">â“ YardÄ±m</button>
    <button id="btnTheme">ğŸŒ“ Tema</button>
  </div>
</header>

<div class="container">
  <!-- Program Editor -->
  <div class="card span-6">
    <h2>ğŸ“ Program EditÃ¶rÃ¼</h2>
    <div class="tabs">
      <div class="tab active" data-tab="simple">Basit Format</div>
      <div class="tab" data-tab="riscv">RISC-V Assembly</div>
    </div>
    
    <div id="tabSimple" class="tab-content">
      <div class="help-panel">
        <h4>Format: OP src1, src2 -> dst</h4>
        <ul>
          <li><strong>ADD</strong>: 1 cycle (ALU)</li>
          <li><strong>MUL</strong>: 3 cycle (MDU)</li>
          <li>Ã–rnek: <code>ADD R1, R2 -> R3</code></li>
        </ul>
      </div>
      <div class="code-editor">
        <textarea id="prog" class="mono">MUL R1, R2 -> R3
ADD R3, R4 -> R5
ADD R2, R6 -> R7
ADD R8, R9 -> R10
MUL R7, R10 -> R11
ADD R5, R11 -> R12</textarea>
      </div>
    </div>

    <div id="tabRiscv" class="tab-content" style="display:none">
      <div class="help-panel">
        <h4>Desteklenen RISC-V KomutlarÄ±</h4>
        <ul>
          <li><strong>add rd, rs1, rs2</strong> - ALU, 1 cycle</li>
          <li><strong>addi rd, rs1, imm</strong> - ALU, 1 cycle</li>
          <li><strong>mul rd, rs1, rs2</strong> - MDU, 3 cycle</li>
          <li><strong>sub rd, rs1, rs2</strong> - ALU, 1 cycle</li>
        </ul>
      </div>
      <div class="code-editor">
        <textarea id="progRiscv" class="mono">mul x3, x1, x2
add x5, x3, x4
add x7, x2, x6
add x10, x8, x9
mul x11, x7, x10
add x12, x5, x11</textarea>
      </div>
    </div>

    <div class="row" style="margin-top:12px;gap:8px">
      <button id="btnLoad" class="success">âœ“ ProgramÄ± YÃ¼kle</button>
      <button class="example-btn" data-example="1">Ã–rnek 1: RAW Hazard</button>
      <button class="example-btn" data-example="2">Ã–rnek 2: Paralel</button>
      <button class="example-btn" data-example="3">Ã–rnek 3: KarmaÅŸÄ±k</button>
    </div>
  </div>

  <!-- Statistics -->
  <div class="card span-6">
    <h2>ğŸ“Š Performans Metrikleri</h2>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">IPC</div>
        <div class="stat-value" id="ipc" style="color:var(--acc)">0.00</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Aktif ROB</div>
        <div class="stat-value" id="activeRob" style="color:var(--warn)">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ALU KullanÄ±m</div>
        <div class="stat-value" id="aluUse" style="color:var(--ok)">0%</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">MDU KullanÄ±m</div>
        <div class="stat-value" id="mduUse" style="color:var(--ok)">0%</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Tamamlanan</div>
        <div class="stat-value" id="commCount" style="color:var(--commit)">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Ä°lerleme</div>
        <div class="stat-value" id="progress" style="font-size:20px">0%</div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressBar"></div>
        </div>
      </div>
    </div>

    <h3 style="margin-top:16px">Pipeline AÅŸamalarÄ±</h3>
    <div class="legend">
      <div class="legend-item">
        <div class="dot dispatch"></div>
        <span>Dispatch</span>
      </div>
      <div class="legend-item">
        <div class="dot issue"></div>
        <span>Issue</span>
      </div>
      <div class="legend-item">
        <div class="dot exec"></div>
        <span>Execute</span>
      </div>
      <div class="legend-item">
        <div class="dot wb"></div>
        <span>Writeback</span>
      </div>
      <div class="legend-item">
        <div class="dot commit"></div>
        <span>Commit</span>
      </div>
      <div class="legend-item">
        <div class="dot stall"></div>
        <span>Stall</span>
      </div>
    </div>
  </div>

  <!-- ROB Table -->
  <div class="card span-8">
    <h2>ğŸ”„ ROB (Reorder Buffer)</h2>
    <div style="overflow-x:auto">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Komut</th>
            <th>Hedef (Phys)</th>
            <th>Durum</th>
            <th>Dispatch</th>
            <th>Issue</th>
            <th>Execute</th>
            <th>Writeback</th>
            <th>Commit</th>
            <th>Gecikme</th>
          </tr>
        </thead>
        <tbody id="rob"></tbody>
      </table>
    </div>
  </div>

  <!-- Functional Units -->
  <div class="card span-4">
    <h2>âš™ï¸ Ä°ÅŸlevsel Birimler</h2>
    <table>
      <thead>
        <tr>
          <th>Birim</th>
          <th>Durum</th>
          <th>Ã‡alÄ±ÅŸtÄ±rÄ±lan</th>
        </tr>
      </thead>
      <tbody id="units"></tbody>
    </table>
  </div>

  <!-- Issue Queue -->
  <div class="card span-8">
    <h2>â³ Issue Queue (Bekleyen Komutlar)</h2>
    <div style="overflow-x:auto">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Komut</th>
            <th>Kaynak Regs (Phys)</th>
            <th>Durum</th>
            <th>Bekleme Nedeni</th>
            <th>BaÄŸÄ±mlÄ±lÄ±k</th>
          </tr>
        </thead>
        <tbody id="iq"></tbody>
      </table>
    </div>
  </div>

  <!-- RAT -->
  <div class="card span-4">
    <h2>ğŸ—‚ï¸ RAT (Register Alias Table)</h2>
    <div id="rat" class="kv mono"></div>
  </div>

  <!-- Timeline -->
  <div class="card span-12">
    <h2>ğŸ“ˆ Zaman Ã‡izelgesi (Son 30 Cycle)</h2>
    <div id="timeline"></div>
  </div>

  <!-- Event Log -->
  <div class="card span-6">
    <h2>ğŸ“‹ Olay GÃ¼nlÃ¼ÄŸÃ¼ (Bu Cycle)</h2>
    <div id="log" class="mono small" style="max-height:200px;overflow-y:auto"></div>
  </div>

  <!-- Hazard Analysis -->
  <div class="card span-6">
    <h2>âš ï¸ Hazard Analizi</h2>
    <div id="hazardAnalysis"></div>
  </div>
</div>

<!-- Instruction Detail Panel -->
<div id="instrDetail" class="card" style="display:none">
  <div class="row" style="justify-content:space-between;margin-bottom:12px">
    <h2>ğŸ” Komut DetayÄ±</h2>
    <button id="btnCloseDetail" style="padding:4px 8px">âœ•</button>
  </div>
  <div id="instrDetailBody"></div>
</div>

<!-- Help Modal -->
<div id="helpModal" class="modal">
  <div class="modal-content">
    <div class="row" style="justify-content:space-between;margin-bottom:16px">
      <h2>ğŸ“š YardÄ±m & DokÃ¼mantasyon</h2>
      <button id="btnCloseHelp">âœ• Kapat</button>
    </div>
    <div style="line-height:1.8">
      <h3>Out-of-Order Pipeline Nedir?</h3>
      <p style="margin-bottom:12px">Out-of-order execution, komutlarÄ±n program sÄ±rasÄ±ndan farklÄ± bir sÄ±rada Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±na izin vererek CPU performansÄ±nÄ± artÄ±rÄ±r.</p>
      
      <h3>Pipeline AÅŸamalarÄ±:</h3>
      <ul style="margin-left:20px;margin-bottom:12px">
        <li><strong>Dispatch:</strong> Komut ROB'a eklenir ve register renaming yapÄ±lÄ±r</li>
        <li><strong>Issue:</strong> TÃ¼m baÄŸÄ±mlÄ±lÄ±klar hazÄ±r olduÄŸunda execution unit'e gÃ¶nderilir</li>
        <li><strong>Execute:</strong> Ä°ÅŸlem gerÃ§ekleÅŸtirilir (ALU: 1 cycle, MDU: 3 cycle)</li>
        <li><strong>Writeback:</strong> SonuÃ§ fiziksel register'a yazÄ±lÄ±r</li>
        <li><strong>Commit:</strong> Komut program sÄ±rasÄ±na gÃ¶re commit edilir</li>
      </ul>

      <h3>Hazard TÃ¼rleri:</h3>
      <ul style="margin-left:20px;margin-bottom:12px">
        <li><strong>RAW (Read After Write):</strong> Bir komut, henÃ¼z yazÄ±lmamÄ±ÅŸ bir deÄŸeri okumaya Ã§alÄ±ÅŸÄ±r</li>
        <li><strong>Structural Hazard:</strong> Ä°ÅŸlevsel birim meÅŸgul (ALU/MDU)</li>
      </ul>

      <h3>KÄ±sayollar:</h3>
      <ul style="margin-left:20px">
        <li><strong>AdÄ±m:</strong> Bir cycle ilerle</li>
        <li><strong>Otomatik:</strong> SÃ¼rekli Ã§alÄ±ÅŸtÄ±r</li>
        <li><strong>Geri:</strong> Ã–nceki state'e dÃ¶n</li>
      </ul>
    </div>
  </div>
</div>

<script>
// ============ CORE SIMULATION ENGINE ============
const LAT = { ADD:1, MUL:3, SUB:1, ADDI:1 };
const FU  = { ADD:"ALU", MUL:"MDU", SUB:"ALU", ADDI:"ALU" };
const UNITS = { ALU:1, MDU:1 };
const ISSUE_WIDTH=2, COMMIT_WIDTH=2;
const ARCH_N=32;

const EXAMPLES = {
  1: `MUL R1, R2 -> R3
ADD R3, R4 -> R5
ADD R5, R6 -> R7`,
  2: `ADD R1, R2 -> R3
ADD R4, R5 -> R6
ADD R7, R8 -> R9
ADD R10, R11 -> R12`,
  3: `MUL R1, R2 -> R3
ADD R3, R4 -> R5
MUL R5, R6 -> R7
ADD R7, R8 -> R9
MUL R2, R10 -> R11
ADD R11, R9 -> R12`
};

function parseProgram(text, isRiscv=false){
  const lines = text.split(/[\r\n]+/).map(s=>s.trim()).filter(Boolean).filter(x=>!x.startsWith('#'));
  const out = [];
  
  for(const [i,line] of lines.entries()){
    if(isRiscv){
      // Parse RISC-V: add x3, x1, x2 or addi x3, x1, 5
      const m = line.match(/^(add|mul|sub|addi)\s+x(\d+)\s*,\s*x(\d+)\s*,\s*(?:x(\d+)|(-?\d+))$/i);
      if(!m) throw new Error(`Line ${i+1}: unsupported RISC-V instruction "${line}"`);
      const op = m[1].toUpperCase();
      const dst = "R"+m[2];
      const src1 = "R"+m[3];
      const src2 = m[4] ? ("R"+m[4]) : ("R0"); // immediate treated as R0 for simplicity
      out.push({op, src:[src1, src2], dst, isImm: !m[4]});
    } else {
      // Parse simple format: ADD R1, R2 -> R3
      const m = line.match(/^([A-Z]+)\s+([Rr]\d+)\s*,\s*([Rr]\d+)\s*->\s*([Rr]\d+)$/);
      if(!m) throw new Error(`Line ${i+1}: bad syntax "${line}"`);
      const op = m[1].toUpperCase();
      if(!(op in FU)) throw new Error(`Line ${i+1}: unsupported OP "${op}"`);
      out.push({op, src:["R"+(+m[2].slice(1)), "R"+(+m[3].slice(1))], dst:"R"+(+m[4].slice(1))});
    }
  }
  return out;
}

function buildInitialState(program){
  const RAT = {}; const readyTime={}; const free=[];
  for(let i=0;i<=ARCH_N;i++){ RAT["R"+i]="p"+i; readyTime["p"+i]=0; }
  for(let i=ARCH_N+1;i<=512;i++) free.push("p"+i);

  let cycle=1;
  const ROB=[];
  for(let i=0;i<program.length;i++){
    const {op,src,dst} = program[i];
    const srcP = [RAT[src[0]], RAT[src[1]]];
    const dstP = free.shift();
    ROB.push({
      idx:i+1, op, src, dst,
      srcP, dstP, fu:FU[op],
      dispatch: cycle, issue:null, start:null, end:null, wb:null, commit:null,
      state:"dispatched"
    });
    RAT[dst]=dstP; readyTime